<!-- Модальное окно -->
<div id="authModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden p-4">
  <div class="neon-card neon-border rounded-2xl overflow-hidden w-full max-w-lg mx-auto">
    <!-- Вкладки -->
    <div class="flex border-b border-white/10">
      <button onclick="switchAuthTab('login')" id="login-tab" class="tab-btn tab-active px-6 py-4 font-medium text-neon-blue hover:text-white transition-all duration-300 w-full text-center">Вход</button>
      <button onclick="switchAuthTab('register')" id="register-tab" class="tab-btn tab-inactive px-6 py-4 font-medium text-neon-pink hover:text-white transition-all duration-300 w-full text-center">Регистрация</button>
    </div>

    <!-- Форма входа -->
    <form id="loginForm" class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Email</label>
        <input type="email" id="email" required class="input-neon w-full px-4 py-3 rounded-lg focus:outline-none" placeholder="your@email.com" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Пароль</label>
        <input type="password" id="password" required class="input-neon w-full px-4 py-3 rounded-lg focus:outline-none" placeholder="••••••••" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Роль</label>
        <select id="role" class="input-neon w-full px-4 py-3 rounded-lg">
          <option value="student">Ученик</option>
          <option value="teacher">Учитель</option>
        </select>
      </div>

      <button type="submit" class="btn-neon w-full py-3 mt-2">Войти</button>
      <div id="login-error" class="text-red-400 text-sm hidden text-center mt-2">Неверный email или пароль</div>
    </form>

    <!-- Форма регистрации -->
    <form id="registerForm" class="p-6 space-y-4 hidden">
      <div>
        <label class="block text-sm font-medium mb-1">Email</label>
        <input type="email" id="reg-email" required class="input-neon w-full px-4 py-3 rounded-lg focus:outline-none" placeholder="your@email.com" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Пароль</label>
        <input type="password" id="reg-password" required class="input-neon w-full px-4 py-3 rounded-lg focus:outline-none" placeholder="••••••••" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Роль</label>
        <select id="reg-role" class="input-neon w-full px-4 py-3 rounded-lg">
          <option value="student">Ученик</option>
          <option value="teacher">Учитель</option>
        </select>
      </div>

      <button type="submit" class="btn-neon w-full py-3 mt-2">Зарегистрироваться</button>
      <div id="register-error" class="text-red-400 text-sm hidden text-center mt-2">Ошибка регистрации</div>
    </form>
  </div>
</div>

<script>
  // Показываем модальное окно при загрузке, если пользователь не авторизован
  document.addEventListener('DOMContentLoaded', async () => {
    const { data: { session }, error } = await supabase.auth.getSession();
    if (!session) {
      document.getElementById('authModal').classList.remove('hidden');
    }
  });

  // Переключение между вкладками
  function switchAuthTab(tab) {
    document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
    document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');

    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');

    [loginTab, registerTab].forEach(t => {
      t.classList.remove('tab-active');
      t.classList.add('tab-inactive');
    });

    if (tab === 'login') {
      loginTab.classList.remove('tab-inactive');
      loginTab.classList.add('tab-active');
    } else {
      registerTab.classList.remove('tab-inactive');
      registerTab.classList.add('tab-active');
    }
  }

  // Обработчики форм
  document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const role = document.getElementById('role').value;
    const errorDiv = document.getElementById('login-error');
    errorDiv.classList.add('hidden');

    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;

      localStorage.setItem('auth', JSON.stringify({
        isAuthenticated: true,
        email: data.user.email,
        role: role,
        userId: data.user.id
      }));

      window.location.reload(); // перезагружаем страницу после входа
    } catch (err) {
      console.error('Ошибка входа:', err.message);
      errorDiv.textContent = 'Неверный email или пароль';
      errorDiv.classList.remove('hidden');
    }
  });

  document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value.trim();
    const role = document.getElementById('reg-role').value;
    const errorDiv = document.getElementById('register-error');
    errorDiv.classList.add('hidden');

    try {
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) throw error;

      localStorage.setItem('auth', JSON.stringify({
        isAuthenticated: true,
        email: email,
        role: role,
        userId: data.user.id
      }));

      window.location.reload();
    } catch (err) {
      console.error('Ошибка регистрации:', err.message);
      errorDiv.textContent = 'Не удалось зарегистрироваться';
      errorDiv.classList.remove('hidden');
    }
  });
</script>
